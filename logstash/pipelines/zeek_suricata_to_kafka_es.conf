input {
  # Zeek connection logs (and others if you add them)
  file {
    path => ["/var/log/zeek/conn.log"]
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/sincedb_zeek_conn"
  }

  # Suricata EVE JSON alerts/flows
  file {
    path => ["/var/log/suricata/eve.json"]
    codec => json
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/sincedb_suricata_eve"
  }
}

filter {
  # Example Zeek TSV parsing (adjust to your zeek log format)
  if "zeek" in [path] or "conn.log" in [path] {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:zeek_ts}\t%{DATA:uid}\t%{IP:src_ip}\t%{INT:src_port}\t%{IP:dst_ip}\t%{INT:dst_port}\t%{WORD:proto}\t%{DATA:service}\t%{INT:duration:int}\t%{INT:orig_bytes:int}\t%{INT:resp_bytes:int}.*" }
      tag_on_failure => ["_zeek_grok_failure"]
    }

    mutate {
      convert => {
        "orig_bytes" => "integer"
        "resp_bytes" => "integer"
      }
      add_tag => ["network_flow"]
    }

    date {
      match => ["zeek_ts", "ISO8601"]
      target => "@timestamp"
    }
  }

  # Suricata events are already JSON, just normalize some field names
  if [event_type] == "alert" {
    mutate {
      add_tag => ["security_alert"]
    }
  }

  # Example normalization
  mutate {
    rename => {
      "[src_ip]" => "source_ip"
      "[dest_ip]" => "destination_ip"
      "[src_port]" => "source_port"
      "[dest_port]" => "destination_port"
    }
  }

  # âœ… MOVED FROM OUTPUT TO FILTER SECTION
  if "security_alert" in [tags] {
    mutate {
      add_field => { "[@metadata][kafka_topic]" => "security_alerts" }
      add_field => { "[@metadata][index]" => "security-alerts" }
    }
  } else if "network_flow" in [tags] {
    mutate {
      add_field => { "[@metadata][kafka_topic]" => "network_flows" }
      add_field => { "[@metadata][index]" => "network-flows" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][kafka_topic]" => "other_events" }
      add_field => { "[@metadata][index]" => "network-other" }
    }
  }
}

output {
  kafka {
    bootstrap_servers => "kafka:9092"
    topic_id => "%{[@metadata][kafka_topic]}"
    codec => json
  }

  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "%{[@metadata][index]}-%{+YYYY.MM.dd}"
    manage_template => false
  }
}